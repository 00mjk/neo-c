###################################################
# installed directories
###################################################
prefix=@prefix@
exec_prefix=@exec_prefix@
bindir=@bindir@
datadir=@datadir@
mandir=@mandir@
sharedstatedir=@sharedstatedir@
sysconfdir=@sysconfdir@/clover2
includedir=@includedir@/clover2
datarootdir=@datarootdir@/clover2
docdir=@datadir@/doc
libdir=@libdir@


###################################################
# environmnet variables
###################################################
CC=@CC@
CXX=@CXX@
INSTALL=@INSTALL@
CFLAGS=@CFLAGS@
CXXFLAGS=@CXXFLAGS@
LIBS=@LIBS@
OS=@OS@
DESTDIR=@DESTDIR@
OBJS=@OBJS@
RUNTIME_OBJS=@RUNTIME_OBJS@
COMMON_OBJS=@COMMON_OBJS@

###################################################
# main
###################################################
all: neo-c 
	if which ctags > /dev/null; then if test $(OS) = DARWIN; then ctags src/*.c > /dev/null 2>&1; else ctags -R; fi; fi

neo-c: config.h src/compiler.o $(COMMON_OBJS) $(OBJS) memalloc.o
	$(CXX) -o neo-c src/compiler.o $(COMMON_OBJS) $(OBJS) $(CFLAGS) $(LIBS) $(CXXFLAGS)

libneo-c.so.1.0.0: $(COMMON_OBJ) $(RUNTIME_OBJS)
	$(CC) -shared -o libneo-c.so.1.0.0 $(RUNTIME_OBJS) $(CFLAGS) $(LIBS)
	ln -s -f libneo-c.so.1.0.0 libneo-c.so.1
	ln -s -f libneo-c.so.1.0.0 libneo-c.so

memalloc.o: src/memalloc.c
	$(CC) -c -o memalloc.o src/memalloc.c

###################################################
# Object files
###################################################
$(OBJS): src/*.h Makefile configure

$(COMMON_OBJS): src/*.h Makefile configure

$(RUNTIME_OBJS): src/*.h Makefile configure

###################################################
# install
###################################################
install:
	mkdir -p $(DESTDIR)/lib
	$(INSTALL) -m 755 ./libneo-c.so.1.0.0 $(DESTDIR)/lib
	$(INSTALL) -m 755 ./libneo-c.so.1 $(DESTDIR)/lib
	$(INSTALL) -m 755 ./libneo-c.so $(DESTDIR)/lib

	mkdir -p $(DESTDIR)/share/man/man1
	$(INSTALL) ./man/neo-c.1.gz $(DESTDIR)/share/man/man1

	mkdir -p "$(DESTDIR)/bin"
	$(INSTALL) -m 755 ./neo-c "$(DESTDIR)/bin"

	mkdir -p $(DESTDIR)/share/doc/neo-c
	$(INSTALL) -m 644 ./manual/*.md "$(DESTDIR)/share/doc/neo-c"

###################################################
# uninstall
###################################################
uninstall:
	rm -f "$(DESTDIR)"/bin/no-c
	rm -f "$(DESTDIR)"/share/neo-c/*
	rmdir "$(DESTDIR)"/share/neo-c
	rm -f "$(DESTDIR)"/share/doc/neo-c/*
	rmdir "$(DESTDIR)"/share/doc/neo-c
	rm -f "$(DESTDIR)"/lib/libneo-c.*
	rm -f "$(DESTDIR)"/share/man/man1/neo-c.1.gz

###################################################
# permission
###################################################
permission:
	chmod 644 *
	chmod 755 .git man src configure
	chmod 644 src/*.c
	chmod 644 src/*.h
	chmod 755 update_neo-c.sh

###################################################
# clean
###################################################
clean:
	rm -fR HelloWorld neo-c neo-c.dSYM src/*.o config.log config.status *.stackdump autom4te.cache .DS_Store core.* core a.out *.bc *.s *.o code/*.o *.ll *.so.1.0.0 *.so src/config.h moveVarDecls.hi moveVarDecls.o moveVarDecls *.so.1 src/*.dwo
	rm -fR code/*.ll code/*.bc code/*.s

distclean: clean
	rm -fR  config.h Makefile autom4te.cache 

###################################################
# test
###################################################
test: 
	@echo "Compile to test code..."
	PWD=`pwd` ./neo-c code/HelloWorld.nc

